class Ve{constructor(){this.channels=new Map}publish(t,...l){this.channels.has(t)&&this.channels.get(t).forEach(s=>{s(...l)})}subscribe(t,l){this.channels.has(t)||this.channels.set(t,new Set),this.channels.get(t).add(l)}unsubscribe(t,l){var s;(s=this.channels.get(t))==null||s.delete(l)}}const n=new Ve,i={snowfallEnable:!0,snowfallCount:100,snowfallColor:"#cd4c4c",snowfallZtop:!0,snowfallColorMode:"static",snowfallMelting:!0,snowfallDirectionMode:"dynamic",snowfallDirectionStaticAngle:90};let te,ne,R,W,le;const A=()=>R,P=()=>W,oe=()=>{R=window.innerHeight,W=window.innerWidth},se=()=>{te=R,ne=W},ie=()=>{le=document.documentElement.scrollWidth>document.documentElement.clientWidth};let u={windowWidth:0,windowHeight:0,windowWidthPrev:0,windowHeightPrev:0,pageXScrollPresence:!1};const ae=()=>{u.windowWidth=W,u.windowHeight=R,u.windowWidthPrev=ne,u.windowHeightPrev=te,u.pageXScrollPresence=le,n.publish("windowResized",u)},H=()=>{se(),oe(),ie(),ae()},Xe=e=>{e?window.addEventListener("resize",H):window.removeEventListener("resize",H)};n.subscribe("canvasAndBlizzardReady",()=>{n.subscribe("enableChange",Xe),chrome.storage.local.get({snowfallEnable:i.snowfallEnable},e=>{e.snowfallEnable&&window.addEventListener("resize",H)}),ae()});se();oe();ie();let re,$;const He=e=>{$=e,ce()},ce=()=>{n.publish("newMouseShiftCoef",$)},Le=({clientX:e})=>{$=e/re-1},L=({windowWidth:e})=>{re=e/2},de=e=>{Le(e),ce()},we=()=>{window.addEventListener("mousemove",de),L({windowWidth:P()}),n.subscribe("windowResized",L)},fe=()=>{window.removeEventListener("mousemove",de),n.unsubscribe("windowResized",L)};let B;chrome.storage.local.get({snowfallDirectionMode:i.snowfallDirectionMode},e=>{B=e.snowfallDirectionMode});const Ye=e=>{e==="static"?fe():we(),B=e},$e=e=>{if(e){if(B!=="dynamic")return;we()}else{if(B!=="dynamic")return;fe()}};n.subscribe("enableChange",$e);class Ze{constructor({fps:t=60,callback:l,tolerance:s=.1}){this.requestID=0,this.fps=t,this.callback=l,this.interval=1e3/this.fps-s}start(){let t=performance.now();const l=s=>{this.requestID=requestAnimationFrame(l);const w=s-t;w>=this.interval&&(t=s-w%this.interval,this.callback(w))};this.requestID=requestAnimationFrame(l)}stop(){cancelAnimationFrame(this.requestID)}}const qe=2*Math.PI;let o,a,Z,d;const Ge=()=>{o=document.createElement("canvas")},Ue=()=>{o.style.height="100%",o.style.width="100%",o.style.backgroundColor="transparent",o.style.position="fixed",o.style.top="0px",o.style.left="0px",o.style.pointerEvents="none",o.style.contain="strict"},je=()=>{a=o.getContext("2d")},ue=({windowWidth:e,windowHeight:t})=>{o.height=t,o.width=e},Ne=()=>{document.documentElement.append(o)},he=e=>{Z=e},q=()=>{a.fillStyle=Z},Ce=e=>{he(e),q()},p=()=>{a.beginPath()},g=({x:e,y:t,radius:l})=>{a.moveTo(e,t),a.arc(e,t,l,0,qe)},Se=e=>{switch(e){case"static":{d=Je();break}case"dynamic":{d=Ke();break}default:throw`unknown canvas fill mode - ${e}`}},Je=()=>(Ce(Z),()=>{a.fill()}),Ke=()=>e=>{a.fillStyle=e,a.fill()},be=()=>{a.clearRect(0,0,o.width,o.height)},me=e=>{e?o.style.zIndex="99999":o.style.zIndex="-1"},Qe=({fillColor:e,windowWidth:t,windowHeight:l,onTop:s,fillMode:w})=>{Ge(),je(),Ue(),ue({windowWidth:t,windowHeight:l}),me(s),Ne(),he(e),q(),Se(w)},_e=({windowWidth:e,windowHeight:t})=>{ue({windowWidth:e,windowHeight:t}),q()};n.subscribe("windowResized",_e);const G=new Set,z=e=>{G.add(e)},T=e=>{G.delete(e)},et=()=>{be(),G.forEach(e=>{e()})},pe=new Ze({fps:60,callback:et}),tt=()=>{pe.start()},nt=()=>{pe.stop()};n.subscribe("startCanvasRender",tt);n.subscribe("stopCanvasRender",nt);class ge{}const h=(e,t)=>Math.floor(Math.random()*(t-e)+e),lt=()=>"#"+Math.floor(Math.random()*16581375).toString(16).padEnd(6,"0"),ot=Math.min(screen.availHeight,screen.availWidth),st=3,F=e=>Number((ot*e/100).toFixed(st)),N=-200,it=200;let Y=0;const at=e=>{Y=-(it*e)};n.subscribe("newMouseShiftCoef",at);const ze=F(.24),Me=F(.375),rt=ze,ct=Me,dt=F(.625),wt=F(1.875),U=F(.00125),ft=2e3,ut=4e3;class ve extends ge{reInit(){this.getColor(),this.resetRadius(),this.getPos(),this.getStep(),this.getGravityCoef(),this.startFallAndGrow()}getColor(){this.color=lt()}getPos(){this.x=this.randomXPos(),this.y=this.randomYPos()}getStep(){this.step=h(rt,ct)}getGravityCoef(){this.yStepCoef=h(dt,wt)/10}resetRadius(){this.radius=0}randomXPos(){return h(Y,P()+Y)}randomYPos(){return h(N,A()+N)}fallAndGrow(){this.grow(),this.radius>=this.fullRadius&&this.justFall(),this.nextStep()}fall(){this.nextStep()}startFallAndGrow(){this.move=this.fallAndGrow}justFall(){this.move=this.fall}grow(){this.radius+=U}nextStep(){this.x+=this.step*this.xStepCoef,this.y+=this.step*this.yStepCoef}setDirectionCoef(t){this.xStepCoef=t}}class ht{static create(){const t=new ve;return t.xStepCoef=0,t.fullRadius=h(ze,Me),t.radiusHalf=Math.floor(t.fullRadius/2),t.reInit(),t}}let b,r={isFallen:!1,isFallenByY:!1},j;const Ct=e=>A()-e.radiusHalf,St=e=>A()-e.radius,bt=({pageXScrollPresence:e})=>{j=e?Ct:St};let x;const mt=e=>e.y>=j(e),pt=e=>e.y>=j(e),ye=e=>{e?x=mt:x=pt},gt=e=>e.x>=P()+e.radiusHalf,zt=e=>e.x<=-e.radius;let S,J;const Mt=e=>(S=x(e),J=gt(e),J||S?(r.isFallen=!0,r.isFallenByY=S):r.isFallen=!1,r);let K;const vt=e=>(S=x(e),K=zt(e),K||S?(r.isFallen=!0,r.isFallenByY=S):r.isFallen=!1,r),Fe=e=>{e>=0?b=Mt:b=vt};chrome.storage.local.get({snowfallMelting:!0},e=>{ye(e.snowfallMelting)});Fe(0);n.subscribe("newMouseShiftCoef",Fe);n.subscribe("windowResized",bt);let Oe=0,f=new Set,M;const yt=e=>{M=e-f.size,M>0?Be(M):M<0&&Ot(Math.abs(M))},Ft=e=>{Oe=e,f.forEach(t=>{t.setDirectionCoef(e)})};let I;const Be=e=>{for(let t=0;t<e;t+=1)I=ht.create(),f.add(I),I.setDirectionCoef(Oe)};let V,Q;const Ot=e=>{Q=f.values();for(let t=0;t<e;t+=1)V=Q.next().value,f.delete(V),n.publish("newFlyingMeltingSnowflake",V)};let c;const Bt=e=>{xe=e};let xe;const De=()=>{p(),f.forEach(e=>{e.move(),c=b(e),c.isFallen&&c.isFallenByY&&n.publish("newMeltingSnowflake",e),c.isFallen&&e.reInit(),g(e)}),d(xe)},xt=()=>{f.forEach(e=>{e.move(),c=b(e),c.isFallen&&c.isFallenByY&&n.publish("newMeltingSnowflake",e),c.isFallen&&e.reInit(),p(),g(e),d(e.color)})};let v=De;const Dt=e=>{switch(T(v),e){case"static":{v=De;break}case"dynamic":{v=xt;break}}z(v)};n.subscribe("newMouseShiftCoef",Ft);n.subscribe("newBlizzard",Be);n.subscribe("newBlizzardSize",yt);z(v);const Ee=e=>{He(Et(e))},Et=e=>-(e-90)/90;chrome.storage.local.get({snowfallDirectionMode:i.snowfallDirectionMode,snowfallDirectionStaticAngle:i.snowfallDirectionStaticAngle},e=>{e.snowfallDirectionMode==="static"&&Ee(e.snowfallDirectionStaticAngle)});class kt extends ge{constructor({x:t,y:l,radius:s,color:w}){super(),this.startMelt=()=>{this.melt=this.meltingStep},this.melt=this.noMeltingStep,this.x=t,this.y=l,this.radius=s,this.color=w,this.meltTimeS=h(ft,ut),setTimeout(this.startMelt,this.meltTimeS)}noMeltingStep(){}meltingStep(){this.radius-=U}}let m=new Set;const ke=()=>m,_=e=>{m.add(new kt(e))};let D;const Rt=()=>{m.forEach(e=>{e.melt(),D=e.radius<=0,D?m.delete(e):(p(),g(e),d(e.color))})},Wt=e=>{Re=e};let Re;const We=()=>{p(),m.forEach(e=>{e.melt(),D=e.radius<=0,D?m.delete(e):g(e)}),d(Re)};let C=We;const At=e=>{switch(T(C),e){case"static":{C=We;break}case"dynamic":{C=Rt;break}}z(C)},Ae=e=>{e?(z(C),n.subscribe("newMeltingSnowflake",_)):(T(C),n.unsubscribe("newMeltingSnowflake",_))};chrome.storage.local.get({snowfallMelting:i.snowfallMelting},e=>{Ae(e.snowfallMelting)});class Pt extends ve{constructor(t){super(),this.init(t)}init(t){this.x=t.x,this.y=t.y,this.radius=t.radius,this.yStepCoef=t.yStepCoef,this.xStepCoef=t.xStepCoef,this.step=t.step,this.color=t.color}melt(){this.radius-=U}fallAndMelt(){this.melt(),this.nextStep()}}let O=new Set;const Tt=e=>{O.forEach(t=>{t.setDirectionCoef(e)})},It=e=>{O.add(new Pt(e))},Pe=e=>{O.delete(e)};let E,k;const Vt=()=>{O.forEach(e=>{e.fallAndMelt(),E=e.radius<=0,k=b(e),E||k.isFallen?Pe(e):(p(),g(e),d(e.color))})},Xt=e=>{Te=e};let Te;const Ie=()=>{p(),O.forEach(e=>{e.fallAndMelt(),E=e.radius<=0,k=b(e),E||k.isFallen?Pe(e):g(e)}),d(Te)};let y=Ie;const Ht=e=>{switch(T(y),e){case"static":{y=Ie;break}case"dynamic":{y=Vt;break}}z(y)};n.subscribe("newFlyingMeltingSnowflake",It);n.subscribe("newMouseShiftCoef",Tt);z(y);const Lt=e=>{e?n.publish("startCanvasRender"):(n.publish("stopCanvasRender"),be()),n.publish("enableChange",e)},Yt=e=>{n.publish("newBlizzardSize",e)};chrome.storage.onChanged.addListener(e=>{"snowfallEnable"in e?Lt(e.snowfallEnable.newValue):"snowfallCount"in e?Yt(e.snowfallCount.newValue):"snowfallColor"in e?(Ce(e.snowfallColor.newValue),Bt(e.snowfallColor.newValue),Wt(e.snowfallColor.newValue),Xt(e.snowfallColor.newValue)):"snowfallZtop"in e?me(e.snowfallZtop.newValue):"snowfallColorMode"in e?(Se(e.snowfallColorMode.newValue),Dt(e.snowfallColorMode.newValue),At(e.snowfallColorMode.newValue),Ht(e.snowfallColorMode.newValue)):"snowfallMelting"in e?(Ae(e.snowfallMelting.newValue),ye(e.snowfallMelting.newValue)):"snowfallDirectionStaticAngle"in e?Ee(e.snowfallDirectionStaticAngle.newValue):"snowfallDirectionMode"in e&&Ye(e.snowfallDirectionMode.newValue)});{const e=(t=()=>{})=>{chrome.storage.local.get({snowfallCount:i.snowfallCount,snowfallColor:i.snowfallColor,snowfallZtop:i.snowfallZtop,snowfallColorMode:i.snowfallColorMode},l=>{Qe({fillColor:l.snowfallColor,onTop:l.snowfallZtop,windowWidth:P(),windowHeight:A(),fillMode:l.snowfallColorMode}),n.publish("newBlizzard",l.snowfallCount),t(),n.publish("canvasAndBlizzardReady")})};n.subscribe("initCanvasAndBlizzard",e)}const $t=({windowWidth:e,windowHeight:t,windowWidthPrev:l,windowHeightPrev:s})=>{e<l&&Zt(e),s!==t&&qt(t)};let X;const Zt=e=>{X=ke(),X.forEach(t=>{t.x>e&&X.delete(t)})},qt=e=>{ke().forEach(l=>{l.y=e-l.radius/2})};n.subscribe("windowResized",$t);const Gt=()=>{document.readyState==="interactive"||document.readyState==="complete"?ee():window.addEventListener("DOMContentLoaded",ee,{once:!0})},ee=()=>{n.publish("initCanvasAndBlizzard",()=>{n.publish("startCanvasRender"),n.publish("enableChange",!0)})};chrome.storage.local.get({snowfallEnable:!0},e=>{if(!e.snowfallEnable){n.publish("initCanvasAndBlizzard");return}Gt()});
